<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Pinq by TimeToogo</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Pinq</h1>
        <h2>PHP Integrated query - Extensible collection query/expression API for PHP</h2>
        <a href="https://github.com/TimeToogo/Pinq" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a name="php-integrated-query" class="anchor" href="#php-integrated-query"><span class="octicon octicon-link"></span></a>PHP Integrated query</h1>

<p><a href="https://travis-ci.org/TimeToogo/Pinq"><img src="https://api.travis-ci.org/TimeToogo/Pinq.png" alt="Build status"></a>
<a href="https://scrutinizer-ci.com/g/TimeToogo/Pinq"><img src="https://scrutinizer-ci.com/g/TimeToogo/Pinq/badges/quality-score.png?s=ddce8f86d3192ab4ca1134aa98e17ab7340014f7" alt="Code quality"></a></p>

<h1>
<a name="what-is-pinq" class="anchor" href="#what-is-pinq"><span class="octicon octicon-link"></span></a>What is Pinq?</h1>

<p>Based off the .NET's <a href="http://msdn.microsoft.com/en-us/library/bb397926.aspx">Linq</a>, Pinq unifies querying across <a href="#pinq-examples">arrays/iterators</a> and <a href="#pinq-external-source">external data sources</a>, in a single readable and concise <a href="#pinq-api">fluent API</a>.</p>

<h1>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h1>

<p>Add package to you composer.json</p>

<div class="highlight highlight-json"><pre><span class="p">{</span>
    <span class="nt">"require"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"timetoogo/pinq"</span><span class="p">:</span> <span class="s2">"dev-master"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h1>
<a name="query-and-collection-api" class="anchor" href="#query-and-collection-api"><span class="octicon octicon-link"></span></a><a name="pinq-api"></a>Query and collection API</h1>

<h1>
<a name="itraversable" class="anchor" href="#itraversable"><span class="octicon octicon-link"></span></a>ITraversable</h1>

<p>The <code>ITraversable</code> interface represents a range of values that are able to be queried upon with the following methods:</p>

<p><strong>Queries</strong></p>

<ul>
<li>
<code>Where</code> - Filters the values according to the supplied predicate</li>
<li>
<code>OrderBy/OrderByAscending/OrderByDescending</code> - Orders the values according the supplied order direction</li>
<li>
<code>ThenBy/ThenByAscending/ThenByDescending</code> - Subsequently orders the values according the supplied order direction</li>
<li>
<code>Skip</code> - Skip the supplied amount of values</li>
<li>
<code>Take</code> - Limits the amount of values by the supplied amount</li>
<li>
<code>Slice</code> - Retrieve a slice of values according to the specified offset and amount</li>
<li>
<code>IndexBy</code> - Index the values according to the supplied mapping function</li>
<li>
<code>GroupBy</code> - Groups the values according the supplied mapping function</li>
<li>
<code>Unique</code> - Only return unique values</li>
<li>
<code>Select</code> - Map the values according to the supplied function</li>
<li>
<code>SelectMany</code> - Map the values according to the supplied function and merge the results</li>
<li>
<code>First</code> - Returns the first value or null if empty</li>
<li>
<code>Last</code> - Returns the last value or null if empty</li>
<li>
<code>Contains</code> - Returns if the supplied value is present in the values</li>
<li>
<code>offsetGet</code> - Returns a value at the supplied index</li>
<li>
<code>offsetExists</code> - Whether a value exists for the supplied index</li>
</ul><p><strong>Set/List Operations</strong></p>

<ul>
<li>
<code>Append</code> - All values present in either the original or supplied values</li>
<li>
<code>WhereIn</code> - All values present in both the original and supplied values</li>
<li>
<code>Except</code> - All values present in the original but not in the supplied values</li>
<li>
<code>Union</code> - Unique values present in either the original or supplied values</li>
<li>
<code>Intersect</code> - Unique values present in both the original and supplied values</li>
<li>
<code>Difference</code> - Unique values present in the original but not in the supplied values</li>
<li>
<code>offsetSet</code> - Sets a value to supplied index</li>
<li>
<code>offsetUnset</code> - Removes any value at the supplied index</li>
</ul><p><strong>Aggregates</strong></p>

<ul>
<li>
<code>Count</code> - The amount of values</li>
<li>
<code>Exists</code> - Whether there are any values</li>
<li>
<code>Aggregate</code> - Aggregates the values according to the supplied</li>
<li>
<code>Maximum</code> - The maximum value</li>
<li>
<code>Minimum</code> - The minimum value</li>
<li>
<code>Sum</code> - The sum of all the values</li>
<li>
<code>Average</code> - The average of all the values</li>
<li>
<code>All</code> - Whether all the values evaluate to true</li>
<li>
<code>Any</code> - Whether any of the values evaluate to true</li>
<li>
<code>Implode</code> - Concatenates the values seperated by the supplied delimiter</li>
</ul><p><strong>Other</strong></p>

<ul>
<li>
<code>AsArray</code> - The values as an array</li>
</ul><h1>
<a name="icollection" class="anchor" href="#icollection"><span class="octicon octicon-link"></span></a>ICollection</h1>

<p>The <code>ICollection</code> interface represents a queryable range of values that are also mutable, they can be manipulated and altered using the additional methods:</p>

<ul>
<li>
<code>Apply</code> - Walks the values with the supplied function</li>
<li>
<code>AddRange</code> - Adds a range of values to the collection</li>
<li>
<code>RemoveRange</code> - Removes a range of values from the collection</li>
<li>
<code>RemoveWhere</code> - Removes the values according to the supplied predicate function</li>
<li>
<code>Clear</code> - Removes all the values from the collection.</li>
</ul><h1>
<a name="some-query-examples" class="anchor" href="#some-query-examples"><span class="octicon octicon-link"></span></a><a name="pinq-examples"></a>Some query examples</h1>

<p>The below examples shows the query functionality using the built-in <code>Traversable</code> class. This is an implementaion of <code>ITraversable</code> that uses iterators to perform the query in-memory.</p>

<div class="highlight highlight-php"><pre><span class="k">use</span> <span class="nx">Pinq\ITraversable</span><span class="p">,</span> <span class="nx">Pinq\Traversable</span><span class="p">;</span>

<span class="c1">//All Even values</span>
<span class="nv">$Numbers</span> <span class="o">=</span> <span class="nx">Traversable</span><span class="o">::</span><span class="na">From</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">Where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$I</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span> <span class="p">});</span>

<span class="c1">//Values multiplied by 10</span>
<span class="nv">$Numbers</span> <span class="o">=</span> <span class="nx">Traversable</span><span class="o">::</span><span class="na">From</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">Select</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$I</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span> <span class="p">});</span>

<span class="c1">//Average string length</span>
<span class="nv">$Strings</span> <span class="o">=</span> <span class="nx">Traversable</span><span class="o">::</span><span class="na">From</span><span class="p">([</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'crocodile'</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">Average</span><span class="p">(</span><span class="s1">'strlen'</span><span class="p">);</span>

<span class="c1">//Order by ascending first then by descending third charater</span>
<span class="nv">$Strings</span> <span class="o">=</span> <span class="nx">Traversable</span><span class="o">::</span><span class="na">From</span><span class="p">([</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">])</span>
        <span class="o">-&gt;</span><span class="na">OrderByAscending</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$I</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="p">})</span>
        <span class="o">-&gt;</span><span class="na">ThenByDescending</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$I</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="p">});</span>

<span class="c1">//A complex example</span>
<span class="nv">$Data</span> <span class="o">=</span> <span class="nx">Traversable</span><span class="o">::</span><span class="na">From</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
        <span class="o">-&gt;</span><span class="na">Where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$I</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span> <span class="p">})</span> <span class="c1">//Only even values</span>
        <span class="o">-&gt;</span><span class="na">OrderByDescending</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$I</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span><span class="p">;</span> <span class="p">})</span> <span class="c1">//Order from largest to smallest</span>
        <span class="o">-&gt;</span><span class="na">GroupBy</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$I</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span> <span class="o">%</span> <span class="mi">7</span><span class="p">;</span> <span class="p">})</span> <span class="c1">//Put into seven groups</span>
        <span class="o">-&gt;</span><span class="na">Where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">ITraversable</span> <span class="nv">$I</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span><span class="o">-&gt;</span><span class="na">Count</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span> <span class="p">})</span> <span class="c1">//Only groups with an even amount of values</span>
        <span class="o">-&gt;</span><span class="na">Select</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">ITraversable</span> <span class="nv">$Numbers</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="s1">'First'</span> <span class="o">=&gt;</span> <span class="nv">$Numbers</span><span class="o">-&gt;</span><span class="na">First</span><span class="p">(),</span>
                <span class="s1">'Average'</span> <span class="o">=&gt;</span> <span class="nv">$Numbers</span><span class="o">-&gt;</span><span class="na">Average</span><span class="p">(),</span>
                <span class="s1">'Count'</span> <span class="o">=&gt;</span> <span class="nv">$Numbers</span><span class="o">-&gt;</span><span class="na">Count</span><span class="p">(),</span>
                <span class="s1">'Numbers'</span> <span class="o">=&gt;</span> <span class="nv">$Numbers</span><span class="o">-&gt;</span><span class="na">AsArray</span><span class="p">(),</span>
            <span class="p">];</span>
        <span class="p">});</span>
</pre></div>

<h1>
<a name="limitations" class="anchor" href="#limitations"><span class="octicon octicon-link"></span></a>Limitations</h1>

<ul>
<li>Within the query, one should not use control structures such as <code>if, switch, goto, while, foreach,...</code>, these are not classified as valid query expressions and cannot be used with external data sources.</li>
</ul><h1>
<a name="querying-on-external-data-sources" class="anchor" href="#querying-on-external-data-sources"><span class="octicon octicon-link"></span></a><a name="pinq-external-source"></a>Querying on external data sources</h1>

<p>The <code>IQueryable</code> and <code>IRepository</code> interfaces are respective to <code>ITraversable</code> and <code>ICollection</code>. But the data source for these is not limited to an array or iterator, they are able to use any implementation of <code>IQueryProvider</code>/<code>IRepositoryProvider</code> respectively, one could query a database, XML, DOM, CSV, the possibilities are endless.</p>

<h1>
<a name="implementing-an-iqueryprovider" class="anchor" href="#implementing-an-iqueryprovider"><span class="octicon octicon-link"></span></a>Implementing an IQueryProvider</h1>

<p>In this exercise to understand the <code>IQueryProvider</code> and how it is to be implemented, we will create a basic query provider for a constant array of numbers <code>[1,2,3,4,5,6,7,8,9,10]</code> (This is pointless as there is <code>Traversable</code> for a PHP array but this should help to illustrate the concept):</p>

<p>The goal of this will be making a query provider capable of executing:</p>

<div class="highlight highlight-php"><pre><span class="nv">$MyQueryableArray</span>
        <span class="o">-&gt;</span><span class="na">Where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$Number</span><span class="p">)</span>  <span class="p">{</span> <span class="k">return</span> <span class="nv">$Number</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">;</span> <span class="p">})</span>
        <span class="o">-&gt;</span><span class="na">Select</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$Number</span><span class="p">)</span>  <span class="p">{</span> <span class="k">return</span> <span class="nv">$Number</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span> <span class="p">})</span>
        <span class="o">-&gt;</span><span class="na">Sum</span><span class="p">();</span>
</pre></div>

<p>To implement a <code>IQueryProvider</code> one must understand the how the query will be represented, a query is represented in two parts:</p>

<ul>
<li>
<strong><code>IScope</code></strong> - This contains many <code>ISegment</code>, each segment represents one or more methods calls from the <code>IQueryable</code> implementation. For example the <code>-&gt;Where(...)</code> would become a <code>Filter</code> segment and the <code>-&gt;Select(...)</code> would becom a <code>Select</code> segment. </li>
<li>
<strong><code>IRequest</code></strong> - This represents the actual data requested, in this case <code>-&gt;Sum()</code>  so a <code>Sum</code> request, but it could be the underlying values (<code>AsArray()</code>), another aggregate (<code>Count()</code>, ...) etc.</li>
</ul><p>There is also the <code>FunctionExpressionTree</code>, functions in the query will be parsed into this class, this contains details of the parameters and an expression tree representing the body of the function.</p>

<p><strong>Steps</strong></p>

<ul>
<li>For the first step we need the a class that will evaluate the expression tree of a given function against the array of values, this will extend the <code>ExpressionVisitor</code> class to traverse the expression tree:</li>
</ul><div class="highlight highlight-php"><pre><span class="k">use</span> <span class="nx">\Pinq\Expressions</span> <span class="k">as</span> <span class="nx">O</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">\Pinq\FunctionExpressionTree</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * To keep it consice we will only implement the bare minimum needed to evaluate the requirements.</span>
<span class="sd"> * This is capable of evaluating a single binary operation involving &gt; or *</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">ExpressionTreeEvaluator</span> <span class="k">extends</span> <span class="nx">O\ExpressionVisitor</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$Array</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$MappedReturnedValues</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$Array</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span> <span class="o">=</span> <span class="nv">$Array</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Nice static method to easily evaluate the return expression against the array</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">EvaluateReturn</span><span class="p">(</span><span class="nx">FunctionExpressionTree</span> <span class="nv">$ExpressionTree</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$Array</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$Evaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span><span class="nv">$Array</span><span class="p">);</span>

        <span class="nv">$Evaluator</span><span class="o">-&gt;</span><span class="na">Walk</span><span class="p">(</span><span class="nv">$ExpressionTree</span><span class="o">-&gt;</span><span class="na">GetFirstResolvedReturnValueExpression</span><span class="p">());</span>

        <span class="k">return</span> <span class="nv">$Evaluator</span><span class="o">-&gt;</span><span class="na">MappedReturnedValues</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">VisitBinaryOperation</span><span class="p">(</span><span class="nx">O\BinaryOperationExpression</span> <span class="nv">$Expression</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//Ignore the left operand, assume it is the value parameter</span>

        <span class="nv">$RightExpression</span> <span class="o">=</span> <span class="nv">$Expression</span><span class="o">-&gt;</span><span class="na">GetRightOperandExpression</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$RightExpression</span> <span class="nx">instanceof</span> <span class="nx">O\ValueExpression</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'I need a constant value on the right side of the query expression'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$RightValue</span> <span class="o">=</span> <span class="nv">$RightExpression</span><span class="o">-&gt;</span><span class="na">GetValue</span><span class="p">();</span>

        <span class="k">switch</span> <span class="p">(</span><span class="nv">$Expression</span><span class="o">-&gt;</span><span class="na">GetOperator</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">O\Operators\Binary</span><span class="o">::</span><span class="na">GreaterThan</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">MappedReturnedValues</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$I</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$RightValue</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span> <span class="o">&gt;</span> <span class="nv">$RightValue</span><span class="p">;</span> <span class="p">},</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="nx">O\Operators\Binary</span><span class="o">::</span><span class="na">Multiplication</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">MappedReturnedValues</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$I</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$RightValue</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$I</span> <span class="o">*</span> <span class="nv">$RightValue</span><span class="p">;</span> <span class="p">},</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'I cannot do this operation: '</span> <span class="o">.</span> <span class="nv">$Expression</span><span class="o">-&gt;</span><span class="na">GetOperator</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<ul>
<li>For the second step we need the a class that will evaluate the query scope of the supplied array, this extends the <code>SegmentVisitor</code> and will evaluate the <code>-&gt;Where(...)-&gt;Select(...)</code> part of the query:</li>
</ul><div class="highlight highlight-php"><pre><span class="k">use</span> <span class="nx">\Pinq\Queries\Segments</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * This is also the bare minimum.</span>
<span class="sd"> * Evaluating only 'Where' and 'Select' and ignoring the rest</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">QueryScopeEvaluator</span> <span class="k">extends</span> <span class="nx">Segments\SegmentVisitor</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$Array</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$Array</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span> <span class="o">=</span> <span class="nv">$Array</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetScopedArray</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">VisitFilter</span><span class="p">(</span><span class="nx">Segments\Filter</span> <span class="nv">$Query</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$MappedResults</span> <span class="o">=</span> <span class="nx">ExpressionTreeEvaluator</span><span class="o">::</span><span class="na">EvaluateReturn</span><span class="p">(</span><span class="nv">$Query</span><span class="o">-&gt;</span><span class="na">GetFunctionExpressionTree</span><span class="p">(),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">);</span>

        <span class="k">foreach</span><span class="p">(</span><span class="nv">$MappedResults</span> <span class="k">as</span> <span class="nv">$Key</span> <span class="o">=&gt;</span> <span class="nv">$Value</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//Remove any values that returned false from the function</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$Value</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">[</span><span class="nv">$Key</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">VisitSelect</span><span class="p">(</span><span class="nx">Segments\Select</span> <span class="nv">$Query</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$MappedResults</span> <span class="o">=</span> <span class="nx">ExpressionTreeEvaluator</span><span class="o">::</span><span class="na">EvaluateReturn</span><span class="p">(</span><span class="nv">$Query</span><span class="o">-&gt;</span><span class="na">GetFunctionExpressionTree</span><span class="p">(),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">);</span>

        <span class="c1">//Set the array to the projections from the function</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span> <span class="o">=</span> <span class="nv">$MappedResults</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<ul>
<li>Now to evaluate the <code>-&gt;Sum()</code> aggregate value, extending the <code>RequestVisitor</code> class, this is responsible for evaluating all the aggregates and retrieving the values:</li>
</ul><div class="highlight highlight-php"><pre>
<span class="k">use</span> <span class="nx">\Pinq\Queries\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">\Pinq\FunctionExpressionTree</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * This is also the bare minimum, evaluating only 'Sum'</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">RequestEvaluator</span> <span class="k">extends</span> <span class="nx">Requests\RequestVisitor</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$Array</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$Array</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span> <span class="o">=</span> <span class="nv">$Array</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">VisitSum</span><span class="p">(</span><span class="nx">Requests\Sum</span> <span class="nv">$Request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//BONUS: if average was called with a projection function we can evaluate that to</span>
        <span class="nv">$ProjectedValues</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">EvaluateProjection</span><span class="p">(</span><span class="nv">$Request</span><span class="p">);</span>

        <span class="nv">$Sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">foreach</span><span class="p">(</span><span class="nv">$ProjectedValues</span> <span class="k">as</span> <span class="nv">$Value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$Sum</span> <span class="o">+=</span> <span class="nv">$Value</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$Sum</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">EvaluateProjection</span><span class="p">(</span><span class="nx">Requests\ProjectionRequest</span> <span class="nv">$Request</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$Request</span><span class="o">-&gt;</span><span class="na">HasFunctionExpressionTree</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">ExpressionTreeEvaluator</span><span class="o">::</span><span class="na">EvaluateReturn</span><span class="p">(</span><span class="nv">$Request</span><span class="o">-&gt;</span><span class="na">GetFunctionExpressionTree</span><span class="p">(),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<ul>
<li>Bringing it all together and implementing the <code>IQueryProvider</code> by extending <code>QueryProvider</code> which implements basic boiler plate for the query provider:</li>
</ul><div class="highlight highlight-php"><pre><span class="k">use</span> <span class="nx">\Pinq\Providers</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">\Pinq\Queries</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ArrayQueryProvider</span> <span class="k">extends</span> <span class="nx">Providers\QueryProvider</span> 
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$Array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">];</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">LoadRequestEvaluatorVisitor</span><span class="p">(</span><span class="nx">Queries\IScope</span> <span class="nv">$Scope</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//Evaluate the query scope: -&gt;Where(...)-&gt;Select(...)</span>
        <span class="nv">$ScopedEvaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryScopeEvaluator</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Array</span><span class="p">);</span>
        <span class="nv">$ScopedEvaluator</span><span class="o">-&gt;</span><span class="na">Walk</span><span class="p">(</span><span class="nv">$Scope</span><span class="p">);</span>
        <span class="nv">$ScopedArray</span> <span class="o">=</span> <span class="nv">$ScopedEvaluator</span><span class="o">-&gt;</span><span class="na">GetScopedArray</span><span class="p">();</span>

        <span class="c1">//Return the request evaluator, it will be called and evaluate the -&gt;Sum() query</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RequestEvaluator</span><span class="p">(</span><span class="nv">$ScopedArray</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<ul>
<li>If we wanted to we could wrap this in a nice subclass of <code>Queryable</code> and automatically pass the appropriate query provider:</li>
</ul><div class="highlight highlight-php"><pre><span class="k">class</span> <span class="nc">ArrayQueryable</span> <span class="k">extends</span> <span class="nx">\Pinq\Queryable</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayQueryProvider</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Finally, we can see the action:</p>

<div class="highlight highlight-php"><pre><span class="nv">$MyQueryableArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayQueryable</span><span class="p">();</span>

<span class="k">echo</span> <span class="nv">$MyQueryableArray</span>
        <span class="o">-&gt;</span><span class="na">Where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$Number</span><span class="p">)</span>  <span class="p">{</span> <span class="k">return</span> <span class="nv">$Number</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">;</span> <span class="p">})</span>
        <span class="o">-&gt;</span><span class="na">Select</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$Number</span><span class="p">)</span>  <span class="p">{</span> <span class="k">return</span> <span class="nv">$Number</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span> <span class="p">})</span>
        <span class="o">-&gt;</span><span class="na">Sum</span><span class="p">();</span>
<span class="c1">//Echos: 400</span>
</pre></div>

<p>This is an extremely basic, useless and naive implementation of the query provider, but nevertheless it does exactly as we wanted. </p>

<p>Hopefully, this helps to illustrate the capabilities of Pinq and its built-in expression language. Its ability and to provide a seamless integration with PHP and external data sources.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/TimeToogo/Pinq/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/TimeToogo/Pinq/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/TimeToogo/Pinq"></a> is maintained by <a href="https://github.com/TimeToogo">TimeToogo</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>